# cspell: ignore nojekyll
name: documentation
on:
  workflow_dispatch:
  push:
    branches:
      - develop
      - main
      - feat/migrate-mkdocs-to-zensical
  pull_request:
    types: [closed]

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          key: ${{ github.ref }}
          path: .cache

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install Doxygen
        run: sudo apt update && sudo apt install -y doxygen

      - name: Set up mkdoxy environment
        run: |
          python -m venv .venv-mkdocs
          . .venv-mkdocs/bin/activate
          pip install --upgrade pip
          pip install mkdoxy==1.2.8

      - name: Generate API reference
        run: |
          . .venv-mkdocs/bin/activate
          rm -rf .mkdoxy
          mkdocs build --config-file scripts/mkdoxy_gen.yml

      - name: Set up Zensical environment
        run: |
          python -m venv .venv-zensical
          . .venv-zensical/bin/activate
          pip install -r docs/requirements.txt

      - name: Preprocess documentation
        run: |
          . .venv-zensical/bin/activate
          python3 scripts/preprocess_zensical_docs.py \
            --site-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"

      - name: Build documentation site
        run: |
          . .venv-zensical/bin/activate
          zensical build --config-file .zensical.toml

      - name: Verify API reference output
        run: test -f _site/core/links/index.html

      - name: Disable Jekyll processing
        run: touch _site/.nojekyll

      - name: Fix file permissions
        run: |
          chmod -c -R +rX "_site/" | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
